<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">
<head th:replace="~{fragments/template :: head}"></head>
<body class="flex w-full flex-1 h-dvh justify-between items-center bg-slate-300">
    <nav th:replace="~{fragments/sidebar :: sidebar}"></nav>
    <main class="flex flex-col h-full w-full overflow-hidden">
        <header th:replace="~{fragments/header :: header}"></header>

        <th:block th:replace="~{fragments/dialogs :: confirmDialog}"></th:block>

        <section class="flex flex-col flex-1 overflow-auto">
            <div class="flex flex-col mx-4 justify-start items-center">

                <!--Panel 1 - Cadastrar Vagas-->
                <div class="w-full bg-white rounded-lg mt-4">
                    <input type="checkbox" id="panel1" class="peer hidden" th:checked="${true}">
                    <label for="panel1"
                           class="text-slate-200 tracking-wide block bg-slate-900 py-4 px-4 rounded-lg cursor-pointer border-2 border-slate-600 hover:bg-slate-800 hover:border-blue-500">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined mr-4">note_stack_add</span>Cadastrar Vagas Disponíveis
                        </div>
                    </label>
                    <div class="flex flex-col justify-center peer-checked:max-h-full max-h-0 overflow-hidden overscroll-contain transition-max-height duration-500 ease-in-out">
                        <div class="py-4 px-4">
                            <div class="flex justify-normal">
                                <div class="p-0.5 w-1/3">
                                    <form id="availableMedicalSlotAddRow"
                                          th:object="${availableMedicalSlot}"
                                          th:attrappend="hx-post=@{/medicalSlot-management/slots/add}"
                                          hx-target="#availableMedicalSlotsFormTable"
                                          hx-on::after-request="if(event.detail.elt.tagName != 'SELECT') clearFormAndSetCurrentMonth()"
                                          hx-swap="outerHTML"
                                          class="space-y-4 bg-slate-50 p-4 rounded-lg">

                                        <div class="flex flex-col w-full">
                                            <label class="text-sm" for="ubsSlots">UBS:</label>
                                            <select class="text-sm w-full rounded-lg border border-stroke py-2 pl-4 mt-1 outline-none focus:ring-2 hover:ring-gray-400 hover:ring-2 hover:border-white focus:border-white focus:ring-blue-500 transition duration-200"
                                                    id="ubsSlots" name="basicHealthUnit"
                                                    required>
                                                <option th:value="${null}">Selecione</option>
                                                <option th:each="ubs : ${basicHealthUnits}"
                                                        th:value="${ubs.id}"
                                                        th:text="${ubs.name}">
                                                </option>
                                            </select>
                                        </div>

                                        <div class="flex flex-col w-full">
                                            <label class="text-sm" for="totalSlots">Vagas:</label>
                                            <input class="text-sm w-full rounded-lg border border-stroke py-2 pl-4 mt-1 outline-none focus:ring-2 hover:ring-gray-400 hover:ring-2 hover:border-white focus:border-white focus:ring-blue-500 transition duration-200"
                                                   type="number" min="1" step="1" id="totalSlots" th:name="totalSlots"
                                                   required>
                                        </div>

                                        <div class="flex flex-col w-full">
                                            <label class="text-sm" for="specialty">Especialidade:</label>
                                            <select class="text-sm w-full rounded-lg border border-stroke py-2 pl-4 mt-1 outline-none focus:ring-2 hover:ring-gray-400 hover:ring-2 hover:border-white focus:border-white focus:ring-blue-500 transition duration-200"
                                                    id="specialty" name="specialty"
                                                    required>
                                                <option th:value="${null}">Selecione</option>
                                                <option th:each="specialty : ${specialties}"
                                                        th:value="${specialty.id}"
                                                        th:text="${specialty.title}"></option>
                                            </select>
                                        </div>

                                        <div class="flex flex-col w-full">
                                            <label class="text-sm" for="procedureType">Marcação:</label>
                                            <select class="text-sm w-full rounded-lg border border-stroke py-2 pl-4 mt-1 outline-none focus:ring-2 hover:ring-gray-400 hover:ring-2 hover:border-white focus:border-white focus:ring-blue-500 transition duration-200"
                                                    id="procedureType" name="procedureType"
                                                    hx-get="/medicalSlot-management/procedures"
                                                    hx-target="#selectMedicalProcedure"
                                                    hx-include="[name='specialty']"
                                                    hx-vals='{"slot":true}'
                                                    hx-swap="outerHTML"
                                                    disabled required>
                                                <option th:value="${null}">Selecione</option>
                                                <option th:each="type : ${T(br.com.tecsus.sigaubs.enums.ProcedureType).values()}"
                                                        th:value="${type.toString()}"
                                                        th:text="${type.description}"></option>
                                            </select>
                                        </div>

                                        <div id="selectMedicalProcedure"
                                             th:replace="~{medicalSlotManagement/medicalSlotFragments/medicalProcedures :: medicalProcedures}">
                                        </div>
                                        <div class="flex flex-col w-full">
                                                <label class="text-sm" for="referenceMonth">Mês de Referência:</label>
                                                <input class="text-sm w-full rounded-lg border border-stroke py-2 pl-4 mt-1 outline-none focus:ring-2 hover:ring-gray-400 hover:ring-2 hover:border-white focus:border-white focus:ring-blue-500 transition duration-200"
                                                       type="month" id="referenceMonth" name="referenceMonth" required>
                                        </div>
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    </form>
                                </div>
                                <div class="p-1 flex items-center">
                                    <button id="addMedicalSlot" form="availableMedicalSlotAddRow"
                                            class="inline-flex p-2 rounded-lg bg-slate-900 text-white cursor-pointer active:bg-blue-400 hover:bg-blue-500 transition duration-300">
                                        <span class="material-symbols-outlined">double_arrow</span>
                                    </button>
                                </div>
                                <div class="p-2 bg-slate-50 overflow-auto max-h-[500px] rounded-lg flex-1">
                                    <form id="availableMedicalSlotsFormTable" class="mt-4">
                                        <table class="min-w-full bg-white">
                                            <thead class="font-light text-sm text-slate-600 text-left tracking-wide">
                                            <tr class="bg-slate-200">
                                                <th class="text-sm rounded-l-lg py-2 px-4">Mês Ref.</th>
                                                <th class="text-sm pl-4">Vagas</th>
                                                <th class="text-sm pl-4">Especialidade</th>
                                                <th class="text-sm pl-4">Marcação</th>
                                                <th class="text-sm pl-4">Procedimento</th>
                                                <th class="text-sm pl-4">UBS</th>
                                                <th class="text-sm rounded-r-lg py-2 px-4">Ações</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </form>
                                </div>
                            </div>
                            <div class="flex justify-start mt-4">
                                <button id="saveButton" type="submit" form="availableMedicalSlotsFormTable"
                                        class="text-sm inline-block rounded-lg bg-slate-900 py-2.5 px-8 text-white cursor-pointer active:bg-blue-400 hover:bg-blue-500 transition duration-300">
                                    Salvar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!--Panel 2 - Histórico de vagas-->
                <div class="w-full bg-white rounded-lg my-4">
                    <input type="checkbox" id="panel2" class="peer hidden" th:checked="${true}">
                    <label for="panel2"
                           class="text-slate-200 tracking-wide block bg-slate-900 py-4 px-4 rounded-lg cursor-pointer border-2 border-slate-600 hover:bg-slate-800 hover:border-blue-500">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined mr-4">history</span>Histórico de vagas
                        </div>
                    </label>
                    <div class="flex flex-col justify-center peer-checked:max-h-[2000px] max-h-0 overflow-hidden overscroll-contain transition-max-height duration-500 ease-in-out">
                        <div class="p-4 rounded-lg">
                            <div th:replace="~{medicalSlotManagement/medicalSlotFragments/medicalSlot-datatable :: medicalSlotsDatatable}"></div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </main>
</body>
<script>

    document.getElementById('saveButton').addEventListener('click', function(event) {
        event.preventDefault();

        Swal.fire({
            title: 'Confirmação',
            text: "Você deseja salvar as alterações?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('availableMedicalSlotsFormTable').submit();
            }
        });
    });

    window.addEventListener("DOMContentLoaded", function () {
        const monthControl = document.querySelector('input[type="month"]');
            const date = new Date();
            const month = ("0" + (date.getMonth() + 1)).slice(-2);
            const year = date.getFullYear();
            monthControl.value = `${year}-${month}`;
    });

    function clearFormAndSetCurrentMonth() {

        document.getElementById('availableMedicalSlotAddRow').reset();

        const currentDate = new Date();
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const currentMonth = `${year}-${month}`;

        document.getElementById('referenceMonth').value = currentMonth;
    }

    $(document).ready(function () {


        // Adicionar um evento de mudança para o select specialty
        $('#specialty').change(function () {
            // Verificar se o valor selecionado é válido (diferente de nulo)
            if ($(this).val()) {
                // Habilitar o select procedureType
                $('#procedureType').prop('disabled', false).val(null);
                $('#medicalProcedure').prop('disabled', true).empty().append('<option th:value="${null}">Selecione</option>');
                $('#priority').prop('disabled', true).empty().append('<option th:value="${null}">Selecione</option>');
            } else {
                // Desabilitar o select procedureType se o valor for nulo
                $('#procedureType').prop('disabled', true).val(null);
            }
        });

        $('#procedureType').change(function () {
            let selectedValue = $('#procedureType option:selected').val();
            if (selectedValue === "Consulta") {
                $('#procedure').val('-').prop('disabled', true);
            } else {
                $('#procedure').prop('disabled', false);
            }
        });


    });
</script>
</html>
